<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEBUG - Comparateur AXA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); }
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-left-color: #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body class="font-sans antialiased bg-gray-100 min-h-screen p-8">

    <div class="max-w-7xl mx-auto mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800">Mode Débogage: Options AXA</h1>
        <p class="text-gray-500">Affichage direct des offres et des listes déroulantes (Mise à jour complète)</p>
    </div>

    <div class="flex justify-center mb-8">
        <div class="inline-flex bg-white rounded-full p-1 shadow-sm border">
            <button onclick="setDuration('annual')" id="btnAnnual" class="px-6 py-2 rounded-full text-sm font-medium bg-indigo-600 text-white shadow-sm transition-all">Annuel</button>
            <button onclick="setDuration('semi')" id="btnSemi" class="px-6 py-2 rounded-full text-sm font-medium text-gray-500 hover:text-gray-700 transition-all">6 Mois</button>
        </div>
    </div>

    <div class="max-w-[1600px] mx-auto">
        <div id="providersContainer" class="space-y-8"></div>
    </div>

    <script>
        let currentDuration = 'annual';

        // ==========================================
        // 1. DATA CONFIGURATION (The "Fixed" Values)
        // ==========================================
        
        const AXA_OPTIONS = {
            // Defense: 4 Options confirmed
            defense: [
                { label: "5 000 DH", value: 1 },
                { label: "7 500 DH", value: 2 },
                { label: "10 000 DH", value: 3 },
                { label: "15 000 DH", value: 4 }
            ],
            
            // PFCP: Full Range 0 to 9
            // Logic: F0 starts at val 1. F6 is val 7. F8 is val 9.
            pfcp: [
                { label: "F0 : 5000/ 5000/ 1000", value: 1 },
                { label: "F1 : 10000/ 10000/ 3000", value: 2 },
                { label: "F2 : 20000/ 20000/ 4000", value: 3 },
                { label: "F3 : 30000/ 30000/ 5000", value: 4 },
                { label: "F4 : 40000/ 40000/ 6000", value: 5 },
                { label: "F5 : 50000/ 50000/ 8000", value: 6 },
                { label: "F6 : 60000/ 60000/ 9000", value: 7 },
                { label: "F7 : 70000/ 70000/ 10000", value: 8 },
                { label: "F8 : 100000/100000/10000", value: 9 },
                { label: "F9 : 120000/120000/12000", value: 10 }
            ],
            
            // Fixed Options
            incendie: [{ label: "SANS", value: 1 }],
            vol: [{ label: "5 %", value: 1 }],
            
            // Bris de Glaces: Expanded List
            glass: [
               { label: "5000 Min. 300 DH", value: 1 },
                { label: "10000 Min. 300 DH", value: 2 },
                { label: "15000 Min. 300 DH", value: 3 },
                { label: "20000 Min. 300 DH", value: 4 },
                { label: "25000 Min. 300 DH", value: 5 },
                { label: "30000 Min. 300 DH", value: 6 },
                { label: "40000 Min.300 DH", value: 7 },
                { label: "50000 Min.300 DH", value: 8 },
                { label: "60000 Min.300 DH", value: 9 },
                { label: "75000 Min.300 DH", value: 10 },
                { label: "100000 Min.300 DH", value: 11 }
            ],
            
            // Dommages Collision: 4 Options
            collision: [
                { label: "Dép. 5% Min 1 000 DH", value: 2 },
                { label: "10 000 DH & 5% Min. 1 000 DH", value: 7 },
                { label: "20 000 DH & 5% Min. 1 000 DH", value: 9 },
                { label: "30 000 DH & 5% Min. 1 000 DH", value: 10 }
            ],
            
            // Dommages Tous Accidents: Expanded List
            all_risk: [
                { label: "3% & Min. 2500 DH", value: 1 },
                { label: "5% & 2500 DH", value: 2 },
                { label: "10% & 3500 DH", value: 4 },
                { label: "10% & 2500 DH", value: 5 },
                { label: "20% & 3500 DH", value: 8 },
                { label: "20% & 2500 DH", value: 9 },
                { label: "Cap. Réduit 3% & Min. 2500 DH", value: 10 },
                { label: "Cap. Réduit 5% & Min. 2500 DH", value: 11 },
                { label: "Cap. Réduit 10% & Min. 3500 DH", value: 13 },
                { label: "Cap. Réduit 10% & Min. 2500 DH", value: 14 },
                { label: "Cap. Réduit 20% & Min. 3500 DH", value: 17 },
                { label: "Cap. Réduit 20% & Min. 2500 DH", value: 18 }
            ]
        };

        // Which dropdowns appear in which pack?
        // Which dropdowns appear in which pack?
        const AXA_PACK_CONFIG = {
            // Basique (Pack 2)
            2: {
                guarantees: [
                    { code: "1", type: "fixed", formule: 0 },   // <-- Added
                    { code: "150", type: "fixed", formule: 0 }, // <-- Added
                    { code: "20", type: "select", options: AXA_OPTIONS.defense, default: 1, title: "Défense et Recours" },
                    { code: "500", type: "select", options: AXA_OPTIONS.pfcp, default: 1, title: "P.F.C.P" }
                ]
            },
            // Basique+ (Pack 3)
            3: {
                guarantees: [
                    { code: "1", type: "fixed", formule: 0 },   // <-- Added
                    { code: "150", type: "fixed", formule: 0 }, // <-- Added
                    { code: "20", type: "fixed", formule: 0 }, // <-- Added
                    { code: "3", type: "select", options: AXA_OPTIONS.incendie, default: 1, title: "Incendie" },
                    { code: "4", type: "select", options: AXA_OPTIONS.vol, default: 1, title: "Vol" },
                    { code: "500", type: "select", options: AXA_OPTIONS.pfcp, default: 1, title: "P.F.C.P" }
                ]
            },
            // Optimale (Pack 4)
            4: {
                guarantees: [
                    { code: "1", type: "fixed", formule: 0 },   // <-- Added
                    { code: "150", type: "fixed", formule: 0 }, // <-- Added
                    { code: "3", type: "select", options: AXA_OPTIONS.incendie, default: 1, title: "Incendie" },
                    { code: "4", type: "select", options: AXA_OPTIONS.vol, default: 1, title: "Vol" },
                    { code: "5", type: "select", options: AXA_OPTIONS.glass, default: 1, title: "Bris de Glaces" },
                    { code: "20", type: "select", options: AXA_OPTIONS.defense, default: 2, title: "Défense et Recours" },
                    { code: "500", type: "select", options: AXA_OPTIONS.pfcp, default: 7, title: "P.F.C.P" },
                    { code: "35", type: "select", options: AXA_OPTIONS.collision, default: 9, title: "Dommages Collision" }
                ]
            },
            // Premium (Pack 5)
            5: {
                guarantees: [
                    { code: "1", type: "fixed", formule: 0 },   // <-- Added
                    { code: "150", type: "fixed", formule: 0 }, // <-- Added
                    { code: "3", type: "select", options: AXA_OPTIONS.incendie, default: 1, title: "Incendie" },
                    { code: "4", type: "select", options: AXA_OPTIONS.vol, default: 1, title: "Vol" },
                    { code: "5", type: "select", options: AXA_OPTIONS.glass, default: 1, title: "Bris de Glaces" },
                    { code: "20", type: "select", options: AXA_OPTIONS.defense, default: 1, title: "Défense et Recours" },
                    { code: "500", type: "select", options: AXA_OPTIONS.pfcp, default: 9, title: "P.F.C.P" },
                    { code: "2", type: "select", options: AXA_OPTIONS.all_risk, default: 11, title: "Dommages Tous Accidents" }
                ]
            }
        };

        // ==========================================
        // 2. MOCK DATA (Simulates API Response)
        // ==========================================
        const MOCK_API_RESPONSE = {
            session_data: { some: "payload_blob" }, 
            providers: [
                {
                    name: "AXA Assurance",
                    code: "axa",
                    plans: [
                        {
                            plan_name: "Basique",
                            plan_code: "axa_0",
                            pack_id: 2,
                            quotation_id: 600000,
                            color: "#1a472a",
                            annual: { prime_total: 2244.19 },
                            semi_annual: { prime_total: 1219.68 }
                        },
                        {
                            plan_name: "Basique+",
                            plan_code: "axa_1",
                            pack_id: 3,
                            quotation_id: 600000,
                            color: "#00008F",
                            annual: { prime_total: 3190.04 },
                            semi_annual: { prime_total: 1811.82 }
                        },
                        {
                            plan_name: "Optimale",
                            plan_code: "axa_2",
                            pack_id: 4,
                            quotation_id: 600000,
                            color: "#003d7a",
                            annual: { prime_total: 4165.21 },
                            semi_annual: { prime_total: 3571.21 }
                        },
                        {
                            plan_name: "Premium",
                            plan_code: "axa_3",
                            pack_id: 5,
                            quotation_id: 600000,
                            color: "#0066FF",
                            annual: { prime_total: 6772.36 },
                            semi_annual: { prime_total: 4959.93 }
                        }
                    ]
                }
            ]
        };

        // ==========================================
        // 3. INITIALIZATION
        // ==========================================
        
        window.onload = function() {
            renderResults(MOCK_API_RESPONSE);
        };

        function setDuration(d) {
            currentDuration = d;
            document.getElementById('btnAnnual').className = d === 'annual' 
                ? 'px-6 py-2 rounded-full text-sm font-medium bg-indigo-600 text-white shadow-sm transition-all'
                : 'px-6 py-2 rounded-full text-sm font-medium text-gray-500 hover:text-gray-700 transition-all';
            
            document.getElementById('btnSemi').className = d === 'semi' 
                ? 'px-6 py-2 rounded-full text-sm font-medium bg-indigo-600 text-white shadow-sm transition-all'
                : 'px-6 py-2 rounded-full text-sm font-medium text-gray-500 hover:text-gray-700 transition-all';
                
            renderResults(MOCK_API_RESPONSE);
        }

        // ==========================================
        // 4. RENDERING FUNCTIONS
        // ==========================================

        function renderResults(data) {
            const container = document.getElementById('providersContainer');
            container.innerHTML = '';

            data.providers.forEach(provider => {
                const plansHtml = provider.plans.map(plan => createPlanCard(plan, provider)).join('');
                
                const html = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
                        <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">${provider.name}</h3>
                            <span class="text-sm bg-blue-100 text-blue-800 py-1 px-3 rounded-full font-medium">DEBUG MODE</span>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            ${plansHtml}
                        </div>
                    </div>`;
                container.innerHTML += html;
            });
        }

        function createPlanCard(plan, provider) {
            const priceObj = currentDuration === 'annual' ? plan.annual : plan.semi_annual;
            const price = priceObj ? priceObj.prime_total : 0;
            const fmtPrice = new Intl.NumberFormat('fr-MA', { style: 'currency', currency: 'MAD' }).format(price);

            let optionsHtml = '';
            if (provider.code === 'axa' && plan.pack_id) {
                optionsHtml = createAxaOptions(plan.pack_id, plan.quotation_id, plan.plan_code);
            }

            return `
                <div class="border rounded-xl p-4 hover:shadow-xl transition-all duration-300 bg-white relative flex flex-col h-full" id="card-${plan.plan_code}">
                    <div class="h-1.5 absolute top-0 left-0 right-0" style="background-color: ${plan.color}"></div>
                    
                    <div class="mb-4">
                        <h4 class="font-bold text-lg text-gray-900">${plan.plan_name}</h4>
                        <div class="mt-2 flex items-baseline gap-1">
                            <span class="text-2xl font-extrabold text-indigo-600 price-display">${fmtPrice}</span>
                            <span class="text-xs text-gray-500 font-medium">/ ${currentDuration === 'annual' ? 'an' : '6 mois'}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-3 mb-6 flex-grow bg-gray-50 p-3 rounded-lg border border-gray-100">
                        ${optionsHtml}
                    </div>

                    <button class="w-full py-2.5 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors shadow-sm mt-auto">
                        Choisir cette offre
                    </button>
                    
                    <div class="absolute inset-0 bg-white/90 hidden flex-col items-center justify-center loading-overlay z-10 backdrop-blur-sm rounded-xl">
                        <div class="spinner mb-2"></div>
                        <span class="text-xs font-semibold text-gray-600">Calcul du nouveau tarif...</span>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // 5. OPTION GENERATOR (UPDATED to show Fixed items)
        // ==========================================

        function createAxaOptions(packId, quoteId, planCode) {
            const config = AXA_PACK_CONFIG[packId];
            if (!config) return '<p class="text-xs text-red-500">Config manquante pour Pack ' + packId + '</p>';

            // We iterate over ALL guarantees now (fixed AND select)
            return config.guarantees.map(g => {
                
                // --- CASE 1: FIXED ITEM (Text with Checkmark) ---
                if (g.type === 'fixed') {
                    // Map code to a friendly name if title is missing (or use title from config if you added it)
                    let title = g.title;
                    if (!title) {
                        if (g.code === "1") title = "RESPONSABILITÉ CIVILE";
                        if (g.code === "150") title = "ÉVÈNEMENTS CATASTROPHIQUES";
                        if (g.code === "20") title = "DÉFENSE ET RECOURS"; 
                    }

                    return `
                        <div class="flex items-center gap-2 py-1">
                            <div class="bg-green-100 rounded-full p-0.5">
                                <svg class="w-3 h-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                            <span class="text-[11px] font-bold text-gray-700 uppercase tracking-wide">${title}</span>
                        </div>
                    `;
                }

                // --- CASE 2: SELECT ITEM (Dropdown) ---
                if (g.type === 'select') {
                    const options = g.options.map(opt => 
                        `<option value="${opt.value}" ${opt.value === g.default ? 'selected' : ''}>${opt.label}</option>`
                    ).join('');
                    
                    return `
                        <div class="mt-2 mb-2">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="bg-green-100 rounded-full p-0.5">
                                    <svg class="w-3 h-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                </div>
                                <label class="text-[11px] uppercase font-bold text-gray-700 tracking-wide">${g.title}</label>
                            </div>
                            <div class="relative pl-6">
                                <select 
                                    class="w-full text-xs border-gray-300 border rounded-md p-2 bg-white text-gray-700 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 axa-select shadow-sm appearance-none pr-8 cursor-pointer hover:border-indigo-300 transition-colors"
                                    data-pack="${packId}"
                                    data-quote="${quoteId}"
                                    data-code="${g.code}"
                                    data-plancode="${planCode}"
                                    onchange="handleAxaChange(this)"
                                >
                                    ${options}
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // ==========================================
        // 6. UPDATE SIMULATION (Prints Payload to Console)
        // ==========================================

        async function handleAxaChange(selectElement) {
            const planCode = selectElement.dataset.plancode;
            const packId = parseInt(selectElement.dataset.pack);
            const card = document.getElementById(`card-${planCode}`);
            
            card.querySelector('.loading-overlay').classList.remove('hidden');
            card.querySelector('.loading-overlay').classList.add('flex');

            const allSelects = card.querySelectorAll('.axa-select');
            const userSelections = {};
            allSelects.forEach(sel => {
                userSelections[sel.dataset.code] = parseInt(sel.value);
            });

            const changes = buildAxaPayload(packId, userSelections);
            
            console.log("------------------------------------------");
            console.log(`[DEBUG] Update Triggered for Pack ${packId}`);
            console.log("User Selections:", userSelections);
            console.log("Generated 'garanties' Payload:", changes);
            console.log("------------------------------------------");

            // Fetch logic is preserved but commented out for visual debug speed if backend isn't running
            /* const basePayload = resultsData.session_data;
            try {
                const response = await fetch('/api/update-quote', {
                    method: 'POST',
                    body: JSON.stringify({
                        provider: 'axa',
                        base_payload: basePayload,
                        quotation_id: quoteId,
                        pack_id: packId,
                        changes: changes
                    })
                });
                ...
            } 
            */

            setTimeout(() => {
                const randomPrice = Math.floor(Math.random() * 500) + 2000;
                const fmtPrice = new Intl.NumberFormat('fr-MA', { style: 'currency', currency: 'MAD' }).format(randomPrice);
                card.querySelector('.price-display').textContent = fmtPrice;
                card.querySelector('.price-display').classList.add('text-green-600');
                
                card.querySelector('.loading-overlay').classList.add('hidden');
                card.querySelector('.loading-overlay').classList.remove('flex');
            }, 600);
        }

        function buildAxaPayload(packId, userSelections) {
            const config = AXA_PACK_CONFIG[packId];
            return config.guarantees.map(g => {
                let val = g.formule;
                if (g.type === 'select') {
                    val = userSelections[g.code] !== undefined ? userSelections[g.code] : g.default;
                }
                return {
                    codeGarantie: g.code,
                    formule: val,
                    typeVehcile: 1
                };
            });
        }
    </script>
</body>
</html>